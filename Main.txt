import yfinance as yf
import pandas as pd
import ta
import os
import requests
from datetime import datetime
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes


# ===== Environment Variables =====
BOT_TOKEN = os.environ.get("BOT_TOKEN")
NEWS_API_KEY = os.environ.get("NEWS_API_KEY")  # Optional for news


# ===== Market Settings =====
symbol = "GC=F"
interval = "60m"


# ===== Get Data =====
def get_data():
    df = yf.download(tickers=symbol, period="7d", interval=interval)
    df.dropna(inplace=True)
    return df


# ===== Indicators =====
def calculate_indicators(df):
    df['EMA200'] = df['Close'].ewm(span=200, adjust=False).mean()
    rsi_indicator = ta.momentum.RSIIndicator(close=df['Close'], window=14)
    df['RSI'] = rsi_indicator.rsi()
    
    # Fibonacci
    recent = df.tail(100)
    high = recent['High'].max()
    low = recent['Low'].min()
    diff = high - low
    df['FIB_382'] = high - diff * 0.382
    df['FIB_618'] = high - diff * 0.618
    return df


# ===== Market Sessions =====
def get_session():
    hour = datetime.utcnow().hour
    if 0 <= hour < 7:
        return "Asian Session (Accumulation)"
    elif 7 <= hour < 13:
        return "London Session (Expansion)"
    elif 13 <= hour < 22:
        return "New York Session (Distribution)"
    else:
        return "Low Liquidity"


# ===== Signals =====
def check_signal(df):
    last = df.iloc[-1]
    price = round(float(last['Close']), 2)
    session = get_session()


    # BUY
    if last['Close'] > last['EMA200'] and last['RSI'] < 35 and last['Close'] <= last['FIB_618']:
        entry = price
        stop_loss = round(entry - 10, 2)
        take_profit = round(entry + 20, 2)
        signal = f"BUY SIGNAL ✅\nTime: {datetime.utcnow()}\nEntry: ${entry}\nStop Loss: ${stop_loss}\nTake Profit: ${take_profit}\nSession: {session}"
    
    # SELL
    elif last['Close'] < last['EMA200'] and last['RSI'] > 65 and last['Close'] >= last['FIB_382']:
        entry = price
        stop_loss = round(entry + 10, 2)
        take_profit = round(entry - 20, 2)
        signal = f"SELL SIGNAL ✅\nTime: {datetime.utcnow()}\nEntry: ${entry}\nStop Loss: ${stop_loss}\nTake Profit: ${take_profit}\nSession: {session}"
    
    # NO CLEAR SIGNAL
    else:
        signal = f"No clear signal\nTime: {datetime.utcnow()}\nPrice: ${price}\nSession: {session}"
    
    return signal


# ===== News =====
def get_news():
    news_list = []
    if NEWS_API_KEY:
        url = f"https://newsapi.org/v2/everything?q=gold&sortBy=publishedAt&apiKey={NEWS_API_KEY}"
        try:
            response = requests.get(url)
            if response.status_code == 200:
                articles = response.json().get('articles', [])[:5]
                for article in articles:
                    news_list.append(article.get('title'))
            else:
                news_list.append("Could not fetch news.")
        except:
            news_list.append("Error fetching news.")
    else:
        news_list.append("News API not set.")
    return news_list


# ===== Telegram Handlers =====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Gold Trading Bot is active. Use /signal or /news.")


async def signal(update: Update, context: ContextTypes.DEFAULT_TYPE):
    df = get_data()
    df = calculate_indicators(df)
    msg = check_signal(df)
    await update.message.reply_text(msg)


async def news(update: Update, context: ContextTypes.DEFAULT_TYPE):
    news_list = get_news()
    message = "Latest Gold News:\n" + "\n".join(f"- {n}" for n in news_list)
    await update.message.reply_text(message)


async def session(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(f"Current Session: {get_session()}")


# ===== Telegram App =====
app = ApplicationBuilder().token(BOT_TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(CommandHandler("signal", signal))
app.add_handler(CommandHandler("news", news))
app.add_handler(CommandHandler("session", session))


print("Bot is running...")
app.run_polling()